name: Auto-promote api-gateway to dev (GitOps)

on:
  workflow_run:
    workflows: ["api-gateway (build & push to ECR)"]
    types: [completed]

permissions:
  contents: write
  id-token: write

concurrency:
  group: api-gateway-auto-promote-dev
  cancel-in-progress: false

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: "461508717137"
  ECR_REPOSITORY: api-gateway

jobs:
  promote-dev:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::461508717137:role/github-actions-ecr-push
          aws-region: ${{ env.AWS_REGION }}

      - name: Compute tag from workflow SHA
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
          echo "tag=sha-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

      - name: Verify image tag exists in ECR
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          echo "Checking ECR for tag: $TAG"

          aws ecr describe-images \
            --region "${{ env.AWS_REGION }}" \
            --repository-name "${{ env.ECR_REPOSITORY }}" \
            --image-ids imageTag="$TAG" >/dev/null

          echo "âœ… Tag exists in ECR: $TAG"

      - name: Update dev values image tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          VALUES_FILE="fintech-gitops/apps/dev/values/api-gateway.yaml"

          if [ ! -f "$VALUES_FILE" ]; then
            echo "ERROR: values file not found: $VALUES_FILE"
            exit 1
          fi

          echo "Before:"
          grep -nE "^[[:space:]]*tag:" "$VALUES_FILE" || true

          sed -i.bak -E "s/^([[:space:]]*tag:).*/\1 ${TAG}/" "$VALUES_FILE"
          rm -f "${VALUES_FILE}.bak"

          echo "After:"
          grep -nE "^[[:space:]]*tag:" "$VALUES_FILE"

      - name: Commit and push to develop
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          VALUES_FILE="fintech-gitops/apps/dev/values/api-gateway.yaml"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$VALUES_FILE"
          git commit -m "chore(dev): promote api-gateway to ${TAG}" || {
            echo "No change to commit."
            exit 0
          }
          git push origin develop
