name: Auto-promote api-gateway to dev (GitOps)

on:
    workflow_run:
        workflows: ["api-gateway (build & push to ECR)"]
        types: [completed]

permissions:
    contents: write

jobs:
    promote-dev:
        if: >
            github.event.workflow_run.conclusion == 'success' &&
            github.event.workflow_run.head_branch == 'develop'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout develop
              uses: actions/checkout@v4
              with:
                  ref: develop

            - name: Update dev values image tag (sha-<short>)
              run: |
                  set -euo pipefail

                  SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
                  TAG="sha-${SHORT_SHA}"
                  VALUES_FILE="fintech-gitops/apps/dev/values/api-gateway.yaml"

                  if [ ! -f "$VALUES_FILE" ]; then
                    echo "ERROR: values file not found: $VALUES_FILE"
                    exit 1
                  fi

                  echo "Promoting to DEV tag: $TAG"
                  sed -i.bak -E "s/^([[:space:]]*tag:).*/\1 ${TAG}/" "$VALUES_FILE"
                  rm -f "${VALUES_FILE}.bak"

                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  git add "$VALUES_FILE"
                  git commit -m "chore(dev): promote api-gateway to ${TAG}" || {
                    echo "No change to commit."
                    exit 0
                  }
                  git push origin develop
