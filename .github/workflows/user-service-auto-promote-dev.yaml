name: Auto-promote user-service to dev (GitOps)

on:
    workflow_run:
        workflows: ["user-service (build & push to ECR)"]
        types: [completed]

permissions:
    contents: write

concurrency:
    group: user-service-auto-promote-dev
    cancel-in-progress: false

jobs:
    promote-dev:
        if: >
            github.event.workflow_run.conclusion == 'success' &&
            github.event.workflow_run.head_branch == 'develop'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout develop
              uses: actions/checkout@v4
              with:
                  ref: develop

            - name: Update dev values image tag (sha-<short>) and push to develop
              shell: bash
              run: |
                  set -euo pipefail

                  SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
                  TAG="sha-${SHORT_SHA}"
                  VALUES_FILE="fintech-gitops/apps/dev/values/user-service.yaml"

                  if [ ! -f "$VALUES_FILE" ]; then
                    echo "ERROR: values file not found: $VALUES_FILE"
                    exit 1
                  fi

                  echo "Promoting user-service to DEV tag: $TAG"
                  sed -i.bak -E "s/^([[:space:]]*tag:).*/\1 ${TAG}/" "$VALUES_FILE"
                  rm -f "${VALUES_FILE}.bak"

                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  git add "$VALUES_FILE"
                  git commit -m "chore(dev): promote user-service to ${TAG}" || {
                    echo "No change to commit."
                    exit 0
                  }

                  git push origin develop
