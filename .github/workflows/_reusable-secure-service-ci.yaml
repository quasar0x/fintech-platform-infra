name: reusable-secure-service-ci

on:
    workflow_call:
        inputs:
            service_name:
                required: true
                type: string
            service_dir:
                required: true
                type: string
            ecr_repository:
                required: true
                type: string
            aws_region:
                required: true
                type: string
            aws_account_id:
                required: true
                type: string
            role_to_assume:
                required: true
                type: string
            run_snyk:
                required: false
                type: boolean
                default: true
            run_semgrep:
                required: false
                type: boolean
                default: true
            fail_trivy_on:
                required: false
                type: string
                default: "HIGH,CRITICAL"
        secrets:
            SNYK_TOKEN:
                required: false
            SEMGREP_APP_TOKEN:
                required: false

permissions:
    contents: read
    id-token: write
    security-events: write

env:
    AWS_REGION: ${{ inputs.aws_region }}
    AWS_ACCOUNT_ID: ${{ inputs.aws_account_id }}
    ECR_REPOSITORY: ${{ inputs.ecr_repository }}
    SERVICE_DIR: ${{ inputs.service_dir }}

concurrency:
    group: secure-ci-${{ inputs.service_name }}-${{ github.ref }}
    cancel-in-progress: false

jobs:
    # -------------------------------------------------
    # PR JOB — test + static/security scanning
    # -------------------------------------------------
    pr-security:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: ${{ env.SERVICE_DIR }}/go.mod
                  cache: true

            - name: Unit tests
              working-directory: ${{ env.SERVICE_DIR }}
              run: |
                  set -euo pipefail
                  go test ./... -count=1

            - name: Semgrep (SAST)
              if: ${{ inputs.run_semgrep }}
              uses: returntocorp/semgrep-action@v1
              with:
                  config: "p/ci"
              env:
                  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

            - name: Snyk (SCA - deps)
              if: ${{ inputs.run_snyk && secrets.SNYK_TOKEN != '' }}
              uses: snyk/actions/golang@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  command: test
                  args: --file=${{ env.SERVICE_DIR }}/go.mod --severity-threshold=high

            - name: Docker build (PR sanity)
              run: |
                  set -euo pipefail
                  docker build "${{ env.SERVICE_DIR }}"

    # -------------------------------------------------
    # PUSH JOB — build, scan, push, sign, verify
    # -------------------------------------------------
    build-scan-push-sign:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest

        outputs:
            image_tag: ${{ steps.meta.outputs.sha_tag }}
            image_digest: ${{ steps.digest.outputs.digest }}
            image_repo: ${{ steps.out.outputs.image }}
            image_ref_digest: ${{ steps.out.outputs.image_ref_digest }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Compute image tag
              id: meta
              run: |
                  set -euo pipefail
                  echo "sha_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: ${{ env.SERVICE_DIR }}/go.mod
                  cache: true

            - name: Unit tests
              working-directory: ${{ env.SERVICE_DIR }}
              run: |
                  set -euo pipefail
                  go test ./... -count=1

            - name: Semgrep (SAST)
              if: ${{ inputs.run_semgrep }}
              uses: returntocorp/semgrep-action@v1
              with:
                  config: "p/ci"
              env:
                  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

            - name: Snyk (SCA - deps)
              if: ${{ inputs.run_snyk && secrets.SNYK_TOKEN != '' }}
              uses: snyk/actions/golang@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  command: test
                  args: --file=${{ env.SERVICE_DIR }}/go.mod --severity-threshold=high

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ inputs.role_to_assume }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              uses: aws-actions/amazon-ecr-login@v2

            - name: Build image (local)
              env:
                  REGISTRY: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
                  SHA_TAG: ${{ steps.meta.outputs.sha_tag }}
              run: |
                  set -euo pipefail
                  IMAGE="$REGISTRY/${{ env.ECR_REPOSITORY }}"
                  docker build \
                    --label org.opencontainers.image.revision="${GITHUB_SHA}" \
                    --label org.opencontainers.image.source="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}" \
                    -t "$IMAGE:$SHA_TAG" \
                    "${{ env.SERVICE_DIR }}"
                  echo "IMAGE=$IMAGE" >> $GITHUB_ENV

            - name: Trivy scan image (fail on severities)
              uses: aquasecurity/trivy-action@0.24.0
              with:
                  image-ref: "${{ env.IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
                  format: "table"
                  exit-code: "1"
                  ignore-unfixed: true
                  severity: ${{ inputs.fail_trivy_on }}

            - name: Generate SBOM (CycloneDX)
              uses: anchore/sbom-action@v0
              with:
                  image: "${{ env.IMAGE }}:${{ steps.meta.outputs.sha_tag }}"
                  format: "cyclonedx-json"
                  output-file: "sbom-${{ inputs.service_name }}-${{ steps.meta.outputs.sha_tag }}.cdx.json"

            - name: Upload SBOM artifact
              uses: actions/upload-artifact@v4
              with:
                  name: sbom-${{ inputs.service_name }}-${{ steps.meta.outputs.sha_tag }}
                  path: sbom-${{ inputs.service_name }}-${{ steps.meta.outputs.sha_tag }}.cdx.json
                  retention-days: 30

            - name: Push image to ECR (immutable-safe)
              env:
                  SHA_TAG: ${{ steps.meta.outputs.sha_tag }}
              run: |
                  set -euo pipefail
                  if aws ecr describe-images \
                    --region "${{ env.AWS_REGION }}" \
                    --repository-name "${{ env.ECR_REPOSITORY }}" \
                    --image-ids imageTag="$SHA_TAG" >/dev/null 2>&1; then
                    echo "Tag exists, skipping push."
                    exit 0
                  fi
                  docker push "${{ env.IMAGE }}:$SHA_TAG"

            - name: Fetch digest from ECR
              id: digest
              env:
                  SHA_TAG: ${{ steps.meta.outputs.sha_tag }}
              run: |
                  set -euo pipefail
                  DIGEST="$(aws ecr describe-images \
                    --region "${{ env.AWS_REGION }}" \
                    --repository-name "${{ env.ECR_REPOSITORY }}" \
                    --image-ids imageTag="${SHA_TAG}" \
                    --query 'imageDetails[0].imageDigest' \
                    --output text)"

                  [[ -z "$DIGEST" || "$DIGEST" == "None" ]] && exit 1
                  echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

            - name: Install cosign
              uses: sigstore/cosign-installer@v3.6.0

            - name: Cosign sign (keyless OIDC)
              env:
                  COSIGN_EXPERIMENTAL: "true"
                  DIGEST: ${{ steps.digest.outputs.digest }}
              run: |
                  set -euo pipefail
                  cosign sign --yes "${{ env.IMAGE }}@${DIGEST}"

            - name: Cosign verify (keyless sanity)
              env:
                  COSIGN_EXPERIMENTAL: "true"
                  DIGEST: ${{ steps.digest.outputs.digest }}
              run: |
                  set -euo pipefail
                  cosign verify \
                    --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
                    "${{ env.IMAGE }}@${DIGEST}" || true

            - name: Export outputs
              id: out
              env:
                  DIGEST: ${{ steps.digest.outputs.digest }}
              run: |
                  set -euo pipefail
                  echo "image=${{ env.IMAGE }}" >> "$GITHUB_OUTPUT"
                  echo "image_ref_digest=${{ env.IMAGE }}@${DIGEST}" >> "$GITHUB_OUTPUT"
