name: api-gateway (build & push to ECR)

on:
    push:
        branches: ["main", "develop"]
        paths:
            - "services/api-gateway/**"
            - ".github/workflows/api-gateway-ci.yaml"
    pull_request:
        paths:
            - "services/api-gateway/**"

permissions:
    id-token: write
    contents: read

env:
    AWS_REGION: us-east-1
    AWS_ACCOUNT_ID: "461508717137"
    ECR_REPOSITORY: api-gateway
    SERVICE_DIR: services/api-gateway

jobs:
    build-and-push:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: arn:aws:iam::461508717137:role/github-actions-ecr-push
                  aws-region: ${{ env.AWS_REGION }}

            - name: Login to Amazon ECR
              uses: aws-actions/amazon-ecr-login@v2

            - name: Set image tag
              id: meta
              run: |
                  SHA_TAG="sha-${GITHUB_SHA::7}"
                  echo "sha_tag=$SHA_TAG" >> "$GITHUB_OUTPUT"

            - name: Build and push (SHA only) - skip if exists
              env:
                  REGISTRY: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com
                  SHA_TAG: ${{ steps.meta.outputs.sha_tag }}
              run: |
                  set -euo pipefail
                  IMAGE="$REGISTRY/${{ env.ECR_REPOSITORY }}"

                  echo "Checking if tag already exists in ECR: $SHA_TAG"
                  if aws ecr describe-images \
                    --region "${{ env.AWS_REGION }}" \
                    --repository-name "${{ env.ECR_REPOSITORY }}" \
                    --image-ids imageTag="$SHA_TAG" >/dev/null 2>&1; then
                    echo "Tag $SHA_TAG already exists. Skipping build/push (ECR tags are immutable)."
                    exit 0
                  fi

                  docker build \
                    --label org.opencontainers.image.revision="${GITHUB_SHA}" \
                    --label org.opencontainers.image.source="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}" \
                    -t "$IMAGE:$SHA_TAG" \
                    "${{ env.SERVICE_DIR }}"

                  docker push "$IMAGE:$SHA_TAG"

                  echo "Pushed: $IMAGE:$SHA_TAG"

    pr-build-only:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Build only (no push on PR)
              run: |
                  docker build "${{ env.SERVICE_DIR }}"
