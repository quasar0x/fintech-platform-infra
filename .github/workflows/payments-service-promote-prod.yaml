name: Promote payments-service to prod (GitOps)

on:
    workflow_dispatch:
        inputs:
            image_tag:
                description: "ECR tag to promote (example: sha-24482af)"
                required: true
            environment:
                description: "Environment folder under fintech-gitops/apps (example: prod)"
                required: true
                default: "prod"

permissions:
    contents: write
    pull-requests: write

jobs:
    promote:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout main
              uses: actions/checkout@v4
              with:
                  ref: main

            - name: Update image tag in values
              shell: bash
              run: |
                  set -euo pipefail

                  ENV="${{ inputs.environment }}"
                  TAG="${{ inputs.image_tag }}"
                  VALUES_FILE="fintech-gitops/apps/${ENV}/values/payments-service.yaml"

                  if [[ "$TAG" != sha-* ]]; then
                    echo "ERROR: image_tag must look like sha-xxxxxxx (example: sha-24482af). Got: $TAG"
                    exit 1
                  fi

                  if [ ! -f "$VALUES_FILE" ]; then
                    echo "ERROR: values file not found: $VALUES_FILE"
                    exit 1
                  fi

                  echo "Before:"
                  grep -nE "^[[:space:]]*tag:" "$VALUES_FILE" || true

                  sed -i.bak -E "s/^([[:space:]]*tag:).*/\1 ${TAG}/" "$VALUES_FILE"
                  rm -f "${VALUES_FILE}.bak"

                  echo "After:"
                  grep -nE "^[[:space:]]*tag:" "$VALUES_FILE"

            - name: Create PR
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  base: main
                  branch: "promote/payments-service-${{ inputs.image_tag }}"
                  title: "Promote payments-service to ${{ inputs.image_tag }}"
                  commit-message: "promote(payments-service): ${{ inputs.image_tag }}"
                  body: |
                      This PR promotes payments-service to `${{ inputs.image_tag }}` by updating:
                      - `fintech-gitops/apps/${{ inputs.environment }}/values/payments-service.yaml`

                      After merge, ArgoCD will sync from `main`.
                  labels: |
                      gitops
                      promote
                  delete-branch: true
