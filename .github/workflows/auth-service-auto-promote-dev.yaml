name: Auto-promote auth-service to dev (GitOps) [digest-verified]

on:
    workflow_run:
        workflows: ["auth-service (secure CI)"]
        types: [completed]

permissions:
    contents: write

concurrency:
    group: auth-service-auto-promote-dev
    cancel-in-progress: false

env:
    AWS_REGION: us-east-1
    AWS_ACCOUNT_ID: "461508717137"
    ECR_REPOSITORY: auth-service

jobs:
    promote-dev:
        if: >
            github.event.workflow_run.conclusion == 'success' &&
            github.event.workflow_run.head_branch == 'develop'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout develop
              uses: actions/checkout@v4
              with:
                  ref: develop

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: arn:aws:iam::461508717137:role/github-actions-ecr-push
                  aws-region: ${{ env.AWS_REGION }}

            - name: Compute tag from workflow SHA
              id: tag
              shell: bash
              run: |
                  set -euo pipefail
                  SHORT_SHA="$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)"
                  echo "tag=sha-${SHORT_SHA}" >> "$GITHUB_OUTPUT"

            - name: Verify tag exists and fetch digest from ECR
              id: digest
              shell: bash
              run: |
                  set -euo pipefail
                  TAG="${{ steps.tag.outputs.tag }}"
                  echo "Checking ECR for ${ECR_REPOSITORY}:${TAG} ..."

                  aws ecr describe-images \
                    --region "${AWS_REGION}" \
                    --repository-name "${ECR_REPOSITORY}" \
                    --image-ids imageTag="${TAG}" >/dev/null

                  DIGEST="$(aws ecr describe-images \
                    --region "${AWS_REGION}" \
                    --repository-name "${ECR_REPOSITORY}" \
                    --image-ids imageTag="${TAG}" \
                    --query 'imageDetails[0].imageDigest' \
                    --output text)"

                  if [[ -z "${DIGEST}" || "${DIGEST}" == "None" ]]; then
                    echo "ERROR: Could not determine digest for ${ECR_REPOSITORY}:${TAG}"
                    exit 1
                  fi

                  echo "âœ… Tag exists. Digest: ${DIGEST}"
                  echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

            - name: Print digest reference (info)
              shell: bash
              run: |
                  set -euo pipefail
                  TAG="${{ steps.tag.outputs.tag }}"
                  DIGEST="${{ steps.digest.outputs.digest }}"
                  IMAGE_REF="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}@${DIGEST}"
                  echo "Promoting auth-service tag=${TAG} digest=${DIGEST}"
                  echo "Image ref (digest): ${IMAGE_REF}"

            - name: Update dev values image tag
              shell: bash
              run: |
                  set -euo pipefail
                  TAG="${{ steps.tag.outputs.tag }}"
                  VALUES_FILE="fintech-gitops/apps/dev/values/auth-service.yaml"

                  if [ ! -f "$VALUES_FILE" ]; then
                    echo "ERROR: values file not found: $VALUES_FILE"
                    exit 1
                  fi

                  echo "Before:"
                  grep -nE "^[[:space:]]*tag:" "$VALUES_FILE" || true

                  sed -i.bak -E "s/^([[:space:]]*tag:).*/\1 ${TAG}/" "$VALUES_FILE"
                  rm -f "${VALUES_FILE}.bak"

                  echo "After:"
                  grep -nE "^[[:space:]]*tag:" "$VALUES_FILE"

            - name: Commit and push to develop
              shell: bash
              run: |
                  set -euo pipefail
                  TAG="${{ steps.tag.outputs.tag }}"
                  VALUES_FILE="fintech-gitops/apps/dev/values/auth-service.yaml"

                  git config user.name "github-actions[bot]"
                  git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                  git add "$VALUES_FILE"
                  git commit -m "chore(dev): promote auth-service to ${TAG} (digest verified)" || {
                    echo "No change to commit."
                    exit 0
                  }
                  git push origin develop
